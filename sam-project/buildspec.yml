version: 0.2
phases:
  install:
    runtime-versions:
      python: 3.8
  build:
    commands:
      - cd sam-project
      - sam build
      - sam deploy --region us-west-1 --stack-name serverlessApp  --resolve-s3 --no-confirm-changeset --no-fail-on-empty-changeset
  post_build:
    commands:
      - cd ..
      - latest_commit_id=$(aws codecommit get-branch --repository-name ServerlessApp --branch-name main --region us-west-1 --query 'branch.commitId' --output text)
      - echo "$latest_commit_id"
      - previous_commit_id=$(aws codecommit get-commit --repository-name ServerlessApp --commit-id $latest_commit_id --region us-west-1 --query 'commit.parents[0]' --output text)
      - echo "$previous_commit_id"
      - folder_to_check="website/"

      - changed_files=$(aws codecommit get-differences --repository-name ServerlessApp --after-commit-spec $latest_commit --before-commit-spec $previous_commit_id --region us-west-1 --query differences[].after.blob.path --output text | grep "$folder_to_check")

      #aws s3 sync website/ s3://myserverlesblog.ajayproject.com
      - |

        if [ -n "$changed_files" ]; then
          echo "Changes detected in 'website/' folder:"
          echo "$changed_files"
          # Perform additional actions or commands here, e.g., sync to S3.
          aws s3 sync website/ s3://myserverlesblog.ajayproject.com
        else
          echo "No changes in 'website/' folder.";
        fi
